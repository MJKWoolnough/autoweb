const e=e=>e instanceof Array&&2===e.length&&e[0]instanceof n,t=e=>e instanceof Array&&2===e.length&&e[0]instanceof s;class n{#e=[];get length(){return this.#e.length}send(e){for(const t of this.#e)try{t(e)}finally{}}receive(e){this.#e.push(e)}remove(e){for(const[t,n]of this.#e.entries())if(n===e)return this.#e.splice(t,1),!0;return!1}bind(e=7){return[1&e?e=>this.send(e):void 0,2&e?e=>this.receive(e):void 0,4&e?e=>this.remove(e):void 0]}static any(t,...s){let o=!1;const r=s.map((t=>t instanceof n?void 0:e(t)?t[1]:t)),i=[];for(const[c,a]of s.entries())if(a instanceof n||e(a)){const e=a instanceof Array?a[0]:a,n=e=>{r[c]=e,o||(o=!0,queueMicrotask((()=>{t(r),o=!1})))};e.receive(n),i.push((()=>e.remove(n)))}return()=>{for(const e of i)e()}}}class s{#t;#n;#s;#o;constructor(e){const[t,s]=(new n).bind(3),o=new n,[,r]=o.bind(2);e(t,(e=>{if(!o.length)throw e;o.send(e)}),(e=>this.#s=e)),this.#t=s,this.#n=r}when(e,t){const n=new s(((n,s)=>{this.#t(e instanceof Function?t=>{try{n(e(t))}catch(e){s(e)}}:n),this.#n(t instanceof Function?e=>{try{n(t(e))}catch(e){s(e)}}:s)}));return n.#o=n.#s=this.#o??=()=>this.#s?.(),n}cancel(){this.#s?.()}catch(e){return this.when(void 0,e)}finally(e){return this.when((t=>(e(),t)),(t=>{throw e(),t}))}splitCancel(e=!1){const[t,o,r]=(new n).bind(),[i,c,a]=(new n).bind();let d=0;return this.when(t,i),()=>new s(((t,n,s)=>{d++,o(t),c(n),s((()=>{r(t),a(n),s((()=>{})),! --d&&e&&this.cancel()}))}))}static merge(...e){return new s(((t,n,s)=>{for(const s of e)s.when(t,n);s((()=>{for(const t of e)t.cancel()}))}))}static any(...e){let n=!1;const[o,r,i,c]=s.bind(),a=e.map((e=>e instanceof s?void 0:t(e)?e[1]:e));for(const[o,c]of e.entries())(c instanceof s||t(c))&&(c instanceof Array?c[0]:c).when((e=>{a[o]=e,n||(n=!0,queueMicrotask((()=>{r(a),n=!1})))}),i);return c((()=>{for(const n of e)(n instanceof s||t(n))&&(n instanceof Array?n[0]:n).cancel()})),o}static bind(e=7){let t,n,o;return[new s(((e,s,r)=>{t=e,n=s,o=r})),1&e?t:void 0,2&e?n:void 0,4&e?o:void 0]}}const o={once:!0},r=new URL(window.location+""),i=XMLHttpRequest;class c extends WebSocket{constructor(e,t){super(new URL(e,r),t)}when(e,t){return new s(((e,t,n)=>{const s=this,o=new AbortController,r={signal:o.signal};s.addEventListener("message",e,r),s.addEventListener("error",(e=>t(e.error)),r),s.addEventListener("close",(e=>{const n=new Error(e.reason);n.name="CloseError",t(n),o.abort()}),r),n((()=>o.abort()))})).when(e,t)}}r.protocol="https"===r.protocol?"wss":"ws";const a="complete"===document.readyState?Promise.resolve():new Promise((e=>window.addEventListener("load",e,{once:!0}))),d=(()=>{let e=Promise.resolve();return t=>e=e.finally(t)})();new Intl.Collator;const l=()=>{},u=[l,l],h=(e,t)=>{const n=new Set;return e.set(t,n),n},w=(e,t,n)=>[s=>{try{!n||n(s)?e(s):t(new TypeError("invalid type"))}catch(e){t(e)}},t];class p{code;message;data;constructor(e,t,n){this.code=e,this.message=t,this.data=n,Object.freeze(this)}get name(){return"RPCError"}toString(){return this.message}}class f extends Array{#r;constructor(e){super(),this.#r=e}close(){for(const e of this)this.#r(e)}send(e){this.push(e)}when(){}}d((()=>a));let m=0,y=0;const v=fetch,g=new class{#i;#c=0;#a=new Map;#d=new Map;#l;#u;constructor(e){this.#h(e)}#h(e){(this.#i=e??new f((e=>this.#i?.send(e)))).when(this.#l??=({data:e})=>{const t=JSON.parse(e),n="string"==typeof t.id?parseInt(t.id):t.id,s=t.error,o=+!!s,r=s?new p(s.code,s.message,s.data):t.result;if(n>=0)(this.#a.get(n)??u)[o](r),this.#a.delete(n);else for(const e of this.#d.get(n)??[])e[o](r)},this.#u??=e=>{this.close();for(const[,t]of this.#a)t[1](e);for(const[,t]of this.#d)for(const n of t)n[1](e)})}reconnect(e){const t=this.#i;this.#h(e),t?.close()}request(e,t,n){const s=this.#i;return s?new Promise(((o,r)=>{n??=t instanceof Function?t:void 0;const i=this.#c++;this.#a.set(i,w(o,r,n)),s.send(JSON.stringify({id:i,method:e,params:t instanceof Function?void 0:t}))})):Promise.reject("RPC Closed")}await(e,t){const n=[l,l],s=this.#d,o=s.get(e)??h(s,e),r=new Promise(((e,s)=>{[n[0],n[1]]=w(e,s,t),o.add(n)}));return r.finally((()=>o.delete(n))).catch((()=>{})),r}subscribe(e,t){return new s(((n,s,o)=>{const r=w(n,s,t),i=this.#d,c=i.get(e)??h(i,e);c.add(r),o((()=>c.delete(r)))}))}close(){const e=this.#i;this.#i=null,e?.close()}},b=Array.from(document.documentElement.children),E=e=>"centre"===e||"middle"===e?"center":e??"left",L=e=>((e,t={})=>new Promise(((n,s)=>{const r=new i;if(r.open(t.method??"GET",e),t.hasOwnProperty("headers")&&"object"==typeof t.headers)for(const[e,n]of Object.entries(t.headers))r.setRequestHeader(e,n);switch(void 0!==t.type&&r.setRequestHeader("Content-Type",t.type),(t.user||t.password)&&r.setRequestHeader("Authorization","Basic "+btoa(`${t.user??""}:${t.password??""}`)),r.addEventListener("readystatechange",(()=>{4===r.readyState&&(r.status>=200&&r.status<300?"json"===t.response&&t.checker&&!t.checker(r.response)?s(new TypeError("received JSON does not match expected format")):n("xh"===t.response?r:r.response):s(new Error(r.response)))})),t.onuploadprogress&&r.upload.addEventListener("progress",t.onuploadprogress),t.ondownloadprogress&&r.addEventListener("progress",t.ondownloadprogress),t.response){case"text":r.overrideMimeType("text/plain");break;case"xml":r.overrideMimeType("text/xml"),r.responseType="document";break;case"json":r.overrideMimeType("application/json");case"document":case"blob":case"arraybuffer":r.responseType=t.response}if(t.signal){const e=t.signal;e.addEventListener("abort",(()=>{r.abort(),s(e.reason instanceof Error?e.reason:new Error(e.reason))}),o)}r.send(t.data??null)})))(e,{headers:{"Cache-Control":"no-cache, no-store, max-age=0"}}).then((t=>{history.pushState(+new Date,"",new URL(e,window.location+"")),document.documentElement.innerHTML=t})),M=Object.freeze({load:L,jumpMouse:(e,t)=>d((()=>g.request("jumpMouse",[m+e|0,y+t|0]))),moveMouse:(e,t)=>d((()=>g.request("moveMouse",[m+e|0,y+t|0]))),clickMouse:e=>d((()=>g.request("clickMouse",E(e)))),dblClickMouse:e=>d((()=>g.request("dblClickMouse",E(e)))),mouseDown:e=>d((()=>g.request("mouseDown",E(e)))),mouseUp:e=>d((()=>g.request("mouseUp",E(e)))),keyPress:e=>d((()=>g.request("keyPress",e))),keyDown:e=>d((()=>g.request("keyDown",e))),keyUp:e=>d((()=>g.request("keyUp",e))),delay:e=>new Promise((t=>setTimeout(t,e))),waitForAnimationFrame:()=>{const{promise:e,resolve:t}=Promise.withResolvers();return requestAnimationFrame(t),e}});window.WebSocket=class extends WebSocket{},window.XMLHttpRequest=class extends XMLHttpRequest{},window.fetch=(e,t)=>v(e,t),window.addEventListener("click",(e=>{let t=e.target;for(;t&&!(t instanceof HTMLAnchorElement||t instanceof HTMLAreaElement||t instanceof SVGAElement);)t=t.parentNode;const n=t?.getAttribute("href"),s=n?new URL(n,window.location+""):null;s?.host===window.location.host&&(L(n??""),e.preventDefault())}));export default(e,t)=>d((()=>new Promise(((e,t)=>{const n=new c("/socket");n.addEventListener("open",(()=>{n.removeEventListener("error",t),e(n)}),o),n.addEventListener("error",t,o)})).then((e=>g.reconnect(e))))).then((async()=>{m=y=0;let e=null,t=-(window.innerWidth>>1),n=window.innerHeight>>1;const s=document.createElement("div"),[o,r]=await g.request("getScreenSize");s.setAttribute("style","position: absolute; top: 0; left: 0; right: 0; bottom: 0"),document.body.replaceChildren(s),await M.waitForAnimationFrame(),s.addEventListener("mouseenter",(t=>{e=[t.clientX,t.clientY],s.remove(),t.preventDefault()}),{once:!0,capture:!0});do{if(t+=window.innerWidth,t>o&&(t=window.innerWidth>>1,n+=window.innerHeight,n>r))return alert("Could not find window."),s.remove(),Promise.reject("unable to find window");await M.jumpMouse(t,n),await M.delay(50)}while(!e);return m=t-e[0]|0,y=n-e[1]|0,M.jumpMouse(window.innerWidth>>1,window.innerHeight>>1)})).then((()=>g.request("proxy",e))).then((()=>t(M))).catch((e=>console.log(e))).finally((()=>{g?.close(),history.pushState(+new Date,"",new URL("/",window.location+"")),document.documentElement.replaceChildren(...b)}));