const e=e=>e instanceof Array&&2===e.length&&e[0]instanceof n,t=e=>e instanceof Array&&2===e.length&&e[0]instanceof s;class n{#e=[];get length(){return this.#e.length}send(e){for(const t of this.#e)try{t(e)}finally{}}receive(e){this.#e.push(e)}remove(e){for(const[t,n]of this.#e.entries())if(n===e)return this.#e.splice(t,1),!0;return!1}bind(e=7){return[1&e?e=>this.send(e):void 0,2&e?e=>this.receive(e):void 0,4&e?e=>this.remove(e):void 0]}static any(t,...s){let o=!1;const r=s.map((t=>t instanceof n?void 0:e(t)?t[1]:t)),i=[];for(const[c,a]of s.entries())if(a instanceof n||e(a)){const e=a instanceof Array?a[0]:a,n=e=>{r[c]=e,o||(o=!0,queueMicrotask((()=>{t(r),o=!1})))};e.receive(n),i.push((()=>e.remove(n)))}return()=>{for(const e of i)e()}}}class s{#t;#n;#s;#o;constructor(e){const[t,s]=(new n).bind(3),o=new n,[,r]=o.bind(2);e(t,(e=>{if(!o.length)throw e;o.send(e)}),(e=>this.#s=e)),this.#t=s,this.#n=r}when(e,t){const n=new s(((n,s)=>{this.#t(e instanceof Function?t=>{try{n(e(t))}catch(e){s(e)}}:n),this.#n(t instanceof Function?e=>{try{n(t(e))}catch(e){s(e)}}:s)}));return n.#o=n.#s=this.#o??=()=>this.#s?.(),n}cancel(){this.#s?.()}catch(e){return this.when(void 0,e)}finally(e){return this.when((t=>(e(),t)),(t=>{throw e(),t}))}splitCancel(e=!1){const[t,o,r]=(new n).bind(),[i,c,a]=(new n).bind();let d=0;return this.when(t,i),()=>new s(((t,n,s)=>{d++,o(t),c(n),s((()=>{r(t),a(n),s((()=>{})),! --d&&e&&this.cancel()}))}))}static merge(...e){return new s(((t,n,s)=>{for(const s of e)s.when(t,n);s((()=>{for(const t of e)t.cancel()}))}))}static any(...e){let n=!1;const[o,r,i,c]=s.bind(),a=e.map((e=>e instanceof s?void 0:t(e)?e[1]:e));for(const[o,c]of e.entries())(c instanceof s||t(c))&&(c instanceof Array?c[0]:c).when((e=>{a[o]=e,n||(n=!0,queueMicrotask((()=>{r(a),n=!1})))}),i);return c((()=>{for(const n of e)(n instanceof s||t(n))&&(n instanceof Array?n[0]:n).cancel()})),o}static bind(e=7){let t,n,o;return[new s(((e,s,r)=>{t=e,n=s,o=r})),1&e?t:void 0,2&e?n:void 0,4&e?o:void 0]}}const o={once:!0},r=XMLHttpRequest,i=(e,t)=>new Promise(((n,s)=>{const r=new c(e,t);r.addEventListener("open",(()=>{r.removeEventListener("error",s),n(r)}),o),r.addEventListener("error",s,o)}));class c extends WebSocket{constructor(e,t){const n=new URL(window.location+"");n.protocol="https"===n.protocol?"wss":"ws",super(new URL(e,n),t)}when(e,t){return new s(((e,t,n)=>{const s=this,o=new AbortController,r={signal:o.signal};s.addEventListener("message",e,r),s.addEventListener("error",(e=>t(e.error)),r),s.addEventListener("close",(e=>{const n=new Error(e.reason);n.name="CloseError",t(n),o.abort()}),r),n((()=>o.abort()))})).when(e,t)}}const a="complete"===document.readyState?Promise.resolve():new Promise((e=>window.addEventListener("load",e,{once:!0}))),d=(()=>{let e=Promise.resolve();return t=>e=e.finally(t)})();new Intl.Collator;const h=()=>{},l=[h,h],u=(e,t)=>{const n=new Set;return e.set(t,n),n},w=(e,t,n)=>[s=>{try{!n||n(s)?e(s):t(new TypeError("invalid type"))}catch(e){t(e)}},t],p=()=>!0,f=e=>new m(0,"unknown endpoint",e);class m{code;message;data;constructor(e,t,n){this.code=e,this.message=t,this.data=n,Object.freeze(this)}get name(){return"RPCError"}toString(){return this.message}}class y extends Array{#r;constructor(e){super(),this.#r=e}close(){for(const e of this)this.#r(e)}send(e){this.push(e)}when(){}}d((()=>a));let v=0,g=0,b=0;const L=fetch,E=new class{#i;#c=0;#a=new Map;#d=new Map;#h;#l;#u=new Map;constructor(e){this.#w(e)}#w(e){(this.#i=e??new y((e=>this.#i?.send(e)))).when(this.#h??=({data:e})=>{const{id:t,result:n,error:s,method:o,params:r}=JSON.parse(e);if(o){const[e,n]=this.#u.get(o)??[f,p];(n(r)?Promise.resolve(e(r)):Promise.reject(new m(0,"bad or invalid params",r))).then((e=>{if(e instanceof m)throw e;this.#i?.send(JSON.stringify({id:t,result:e}))})).catch((e=>this.#i?.send(JSON.stringify({id:t,error:e instanceof m?e:new m(0,e)}))))}else{const e="string"==typeof t?parseInt(t):t,o=+!!s,r=s?new m(s.code,s.message,s.data):n;if(t>=0)(this.#a.get(e)??l)[o](r),this.#a.delete(e);else for(const t of this.#d.get(e)??[])t[o](r)}},this.#l??=e=>{this.close();for(const[,t]of this.#a)t[1](e);for(const[,t]of this.#d)for(const n of t)n[1](e)})}reconnect(e){const t=this.#i;this.#w(e),t?.close()}request(e,t,n){const s=this.#i;return s?new Promise(((o,r)=>{n??=t instanceof Function?t:void 0;const i=this.#c++;this.#a.set(i,w(o,r,n)),s.send(JSON.stringify({id:i,method:e,params:t instanceof Function?void 0:t}))})):Promise.reject("RPC Closed")}await(e,t){const n=[h,h],s=this.#d,o=s.get(e)??u(s,e),r=new Promise(((e,s)=>{[n[0],n[1]]=w(e,s,t),o.add(n)}));return r.finally((()=>o.delete(n))).catch((()=>{})),r}subscribe(e,t){return new s(((n,s,o)=>{const r=w(n,s,t),i=this.#d,c=i.get(e)??u(i,e);c.add(r),o((()=>c.delete(r)))}))}register(e,t,n){t?this.#u.set(e,[t,n??p]):this.#u.delete(e)}close(){const e=this.#i;this.#i=null,e?.close()}},k=Array.from(document.documentElement.children),q=e=>"centre"===e||"middle"===e?"center":e??"left",M=e=>((e,t={})=>new Promise(((n,s)=>{const i=new r;if(i.open(t.method??"GET",e),t.hasOwnProperty("headers")&&"object"==typeof t.headers)for(const[e,n]of Object.entries(t.headers))i.setRequestHeader(e,n);switch(void 0!==t.type&&i.setRequestHeader("Content-Type",t.type),(t.user||t.password)&&i.setRequestHeader("Authorization","Basic "+btoa(`${t.user??""}:${t.password??""}`)),i.addEventListener("readystatechange",(()=>{4===i.readyState&&(i.status>=200&&i.status<300?"json"===t.response&&t.checker&&!t.checker(i.response)?s(new TypeError("received JSON does not match expected format")):n("xh"===t.response?i:i.response):s(new Error(i.response)))})),t.onuploadprogress&&i.upload.addEventListener("progress",t.onuploadprogress),t.ondownloadprogress&&i.addEventListener("progress",t.ondownloadprogress),t.response){case"text":i.overrideMimeType("text/plain");break;case"xml":i.overrideMimeType("text/xml"),i.responseType="document";break;case"json":i.overrideMimeType("application/json");case"document":case"blob":case"arraybuffer":i.responseType=t.response}if(t.signal){const e=t.signal;e.addEventListener("abort",(()=>{i.abort(),s(e.reason instanceof Error?e.reason:new Error(e.reason))}),o)}i.send(t.data??null)})))(e,{headers:{"Cache-Control":"no-cache, no-store, max-age=0"}}).then((t=>{history.pushState(+new Date,"",new URL(e,window.location+"")),document.documentElement.innerHTML=t})),R=new Map,S=new Map,A=Object.freeze({load:M,jumpMouse:(e,t)=>d((()=>E.request("jumpMouse",[v+e|0,g+t|0]))),moveMouse:(e,t)=>d((()=>E.request("moveMouse",[v+e|0,g+t|0]))),clickMouse:e=>d((()=>E.request("clickMouse",q(e)))),dblClickMouse:e=>d((()=>E.request("dblClickMouse",q(e)))),mouseDown:e=>d((()=>E.request("mouseDown",q(e)))),mouseUp:e=>d((()=>E.request("mouseUp",q(e)))),keyPress:e=>d((()=>E.request("keyPress",e))),keyDown:e=>d((()=>E.request("keyDown",e))),keyUp:e=>d((()=>E.request("keyUp",e))),delay:e=>new Promise((t=>setTimeout(t,e))),waitForAnimationFrame:()=>{const{promise:e,resolve:t}=Promise.withResolvers();return requestAnimationFrame(t),e},hook:(e,t)=>{const n=t?e=>{const n=t(e);return n&&(n.code??=200,n.headers=Object.fromEntries((n?.headers instanceof Map?n.headers.entries():Object.entries(n.headers??{})).map((([e,t])=>[e,t instanceof Array?t:[t]])))),n}:t;E.register(e,n),n?E.request("addHook",e).then((()=>R.set(e,n))):E.request("removeHook",e).then((()=>R.delete(e)))},hookWS:(e,t)=>{t?S.set(e,t):S.delete(e)}});window.WebSocket=class extends WebSocket{constructor(e,t){const n=S.get("string"==typeof e?e:e.toString());if(n){const s="X-HOOKED-WS:"+b++;e="/",t instanceof Array?t.splice(0,0,s):t=t?s+", "+t:s,i("/",s).then(n)}super(e,t)}},window.XMLHttpRequest=class extends XMLHttpRequest{#p="";open(e,t,n=!0,s,o){const r=(t instanceof URL?t:new URL(t,window.location+"")).toString();R.has(r)&&(t="/",this.#p=r),super.open(e,t,n,s,o)}send(e){this.#p&&this.setRequestHeader("X-HOOK",this.#p),super.send(e)}},window.fetch=(e,t)=>{const n=(e instanceof URL?e:new URL(e instanceof Request?e.url:e,window.location+"")).toString();return R.has(n)&&(e=new Request("/",e instanceof Request?e:void 0),t&&(e=new Request(e,t),t=void 0),e.headers.set("X-HOOK",n)),L(e,t)},window.addEventListener("click",(e=>{let t=e.target;for(;t&&!(t instanceof HTMLAnchorElement||t instanceof HTMLAreaElement||t instanceof SVGAElement);)t=t.parentNode;const n=t?.getAttribute("href"),s=n?new URL(n,window.location+""):null;s?.host===window.location.host&&(M(n??""),e.preventDefault())}));export default(e,t)=>d((()=>i("/socket").then((e=>E.reconnect(e))))).then((async()=>{v=g=0;let e=null,t=-(window.innerWidth>>1),n=window.innerHeight>>1;const s=document.createElement("div"),[o,r]=await E.request("getScreenSize");s.setAttribute("style","position: absolute; top: 0; left: 0; right: 0; bottom: 0"),document.body.replaceChildren(s),await A.waitForAnimationFrame(),s.addEventListener("mouseenter",(t=>{e=[t.clientX,t.clientY],s.remove(),t.preventDefault()}),{once:!0,capture:!0});do{if(t+=window.innerWidth,t>o&&(t=window.innerWidth>>1,n+=window.innerHeight,n>r))return alert("Could not find window."),s.remove(),Promise.reject("unable to find window");await A.jumpMouse(t,n),await A.delay(50)}while(!e);return v=t-e[0]|0,g=n-e[1]|0,A.jumpMouse(window.innerWidth>>1,window.innerHeight>>1)})).then((()=>E.request("proxy",e))).then((()=>t(A))).catch((e=>console.log(e))).finally((()=>{E.close(),history.pushState(+new Date,"",new URL("/",window.location+"")),document.documentElement.replaceChildren(...k)}));